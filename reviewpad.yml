api-version: reviewpad.com/v3.x

mode: silent

labels:
  small:
    description: Small changes
    # color is the hexadecimal color code for the label, without the leading #.
    color: "294b69"
  medium:
    description: Medium changes
    color: "a8c3f7"
  large:
    description: Large changes
    color: "8a2138"
  external-contribution:
    description: External contribution
    color: "8a2151"
  schema:
    description: Changes to the schema
    color: "8a2022"

groups:
  - name: maintainers
    description: Official maintainers
    kind: developers
    spec: '["marcelosousa", "ferreiratiago", "shay2025"]'

rules:
  - name: is-small
    kind: patch
    description: small pull request
    spec: '$size() <= 30'

  - name: is-medium
    kind: patch
    description: medium-sized pull request
    spec: '$size() > 30 && $size() <= 100'

  - name: empty-description
    kind: patch
    description: Pull request has an empty description
    spec: '$title() == ""'

  - name: is-large
    kind: patch
    description: large-sized pull request
    spec: '$size() > 100'

  - name: touches-schema
    kind: patch
    description: modifies the schema file
    spec: '$hasFileName("latest/schema.json")'

  - name: touches-schema-and-other-files
    kind: patch
    description: modifies the schema file and other files
    spec: '$rule("touches-schema") && $fileCount() > 1'

  - name: touches-unexpected-file
    kind: patch
    description: modifies an unexpected file
    spec: '!($rule("touches-schema") || $hasFileName(".github/workflows/reviewpad.yml") || $hasFileName("reviewpad.yml") || $hasFileName("README.md"))'

  - name: does-not-have-linear-history
    kind: patch
    description: Pull request does not have a linear history
    spec: '!$hasLinearHistory()'

  - name: authored-by-maintainers
    spec: $isElementOf($author(), $group("maintainers"))

  - name: authored-by-external-contributors
    spec: '!$isElementOf($author(), $group("maintainers"))'
  
  - name: ship-state
    spec: $contains($description(), "[x] Ship:") || $isElementOf("ship", $labels())

  - name: show-state
    spec: $contains($description(), "[x] Show:") || $isElementOf("show", $labels())

  - name: explicit-ask-state
    spec: $contains($description(), "[x] Ask:") || $isElementOf("ask", $labels()) || $rule("authored-by-external-contributors")

  - name: ask-state
    spec: '(!$rule("ship-state") && !$rule("show-state")) || $rule("explicit-ask-state")'

workflows:
  - name: lint-workflow
    description: Lint the pull request
    # always-run is a boolean property to control if this workflow should always be executed
    always-run: true
    if:
      - rule: empty-description
        # if 'empty-description' is true, the 'extra-actions' property will be 
        # executed after the main actions
        extra-actions:
          - '$error("Pull request has an empty description.")'
      - rule: touches-schema
        extra-actions:
          - '$addLabel("schema")'
      - rule: touches-schema-and-other-files
        extra-actions:
          - '$warn("If the pull request modifies the schema, it should not modify more files.")'
      - rule: touches-unexpected-file
        extra-actions:
          - '$info("This pull request modifies an unexpected file!")'
      - rule: does-not-have-linear-history
        extra-actions:
          - '$error("This pull does not seem to have a linear history.")'

  - name: add-label-with-size
    description: Add label with size of the pull request
    always-run: true
    if:
      - rule: is-small
        extra-actions:
          - '$addLabel("small")'
      - rule: is-medium
        extra-actions:
          - '$addLabel("medium")'
      - rule: is-large
        extra-actions:
          - '$addLabel("large")'

  - name: default-review-process
    always-run: true
    if:
      - rule: authored-by-maintainers
        extra-actions:
          - $assignReviewer($group("maintainers"), 1)
          - $assignAssignees([$author()])
      - rule: authored-by-external-contributors
        extra-actions:
          - $addLabel("external-contribution")
          - $assignReviewer($group("maintainers"), 1)
          - $assignAssignees(["ferreiratiago"])

  - name: first-time-issue-contributor
    on:
      - "issue"
    always-run: true
    if:
      - rule: $issueCountBy($author(), "all") == 1
        extra-actions:
          - $commentOnce($sprintf("Welcome @%v! Thank you so much for your first issue!", [$author()]))

  - name: first-time-pr-contributor
    on:
      - "pull_request"
    always-run: true
    if:
      - rule: $pullRequestCountBy($author(), "all") == 1
        extra-actions:
          - $commentOnce($sprintf("Welcome @%v! Thank you so much for your first pull request!", [$author()]))
  
  - name: label-ship-show-ask
    # at all times we only have one label
    always-run: true
    if:
      - rule: ship-state
        extra-actions:
          - $removeLabel("ask")
          - $removeLabel("show")
          - $addLabel("ship")
          - $merge("rebase")
      - rule: show-state
        extra-actions:
          - $removeLabel("ask")
          - $removeLabel("ship")
          - $addLabel("show")
      - rule: ask-state
        extra-actions:
          - $removeLabel("ship")
          - $removeLabel("show")
          - $addLabel("ask")

